# 在一个合约里面创建新的合约

在Solidity中，在一个合约内部创建新合约（即合约工厂模式）主要有两种方式：

1. 使用`new`关键字

2. 使用CREATE2操作码（通过内联汇编或Solidity的`new`关键字加`salt`选项）

## 1. 使用 new 关键字（最常用方式）

```solidity
// 被创建的合约
contract Child {
    uint public value;
    constructor(uint _value) {
        value =_value;
    }
}

// 工厂合约
contract Factory {
    address public childAddress;

    function createChild(uint _value) public {
        Child newChild = new Child(_value); // 创建新合约
        childAddress = address(newChild);  // 获取新合约地址
    }
}
```

## 2. 使用 CREATE2（确定性地址部署）

```solidity
contract Factory {
    function create2Child(uint _value, bytes32_salt) public returns (address) {
        // 使用 salt 创建确定性地址合约
        Child newChild = new Child{salt: _salt}(_value);
        return address(newChild);
    }

    // 预先计算 CREATE2 地址
    function computeAddress(bytes32 _salt, uint_value) public view returns (address) {
        bytes memory bytecode = abi.encodePacked(
            type(Child).creationCode,   // 获取合约创建字节码
            abi.encode(_value)          // 编码构造函数参数
        );
        bytes32 hash = keccak256(abi.encodePacked(
            bytes1(0xff),
            address(this),
            _salt,
            keccak256(bytecode)
        ));
        return address(uint160(uint(hash)));
    }
}
```

## 关键说明

### new 关键字

每次调用 new 会生成一个新地址。

需支付 Gas 费用（包含部署和构造函数执行成本）。

### CREATE2 特性

使用 salt 参数生成确定性地址。

相同 salt + 相同字节码 → 相同地址。

适用于状态通道、Layer2 等场景。

### 获取新合约地址

通过 address(newContract) 获取部署后的地址。

### 构造函数传参

在 new ContractName(arg1, arg2) 中传递参数。

## 注意事项

Gas 消耗：创建合约消耗较多 Gas，需预留足够费用。

安全风险：新合约的代码需经过审计，避免在工厂合约中引入漏洞。

地址管理：建议在工厂合约中存储创建的子合约地址（例如 mapping 或数组）。

通过以上方法，你可以实现在一个合约中动态创建其他合约。
