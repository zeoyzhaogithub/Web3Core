# 库（library）

在Solidity中，库（library）是一种特殊的合约，旨在提供可复用的代码逻辑。与普通合约不同，库不能拥有状态变量（不能定义 storage 变量），不能继承或被继承，也不能接收以太币（除非实现 payable 函数）。其主要目的是通过代码复用提高安全性和降低 Gas 消耗。

## 核心特性

### 无状态性

不能声明 storage 变量（但可操作调用合约的存储）。

可定义 memory 或 constant 变量。

不能继承或被继承（is 关键字无效）。

### 函数类型

internal 函数：内联到调用合约中，无调用开销（Gas 更低）。

public/external 函数：通过 DELEGATECALL 执行，可操作调用合约的存储。

### 部署与复用

每个库在链上仅需部署一次，后续合约通过地址复用。

若库函数均为 internal，则代码直接嵌入合约，无需单独部署。

## 使用场景

为数据类型添加方法（如 using SafeMath for uint256）。

封装通用算法（如数学计算、地址校验）。

节省 Gas：复用已部署代码，避免重复部署。

增强安全性：集中审计常用逻辑（如防溢出的数学运算）。

## 定义与语法

```solidity
// 定义库
library MathUtils {
    // internal 函数（内联调用）
    function add(uint256 a, uint256 b) internal pure returns (uint256) {
        return a + b;
    }

    // public 函数（通过 DELEGATECALL 调用）
    function multiply(uint256 a, uint256 b) public pure returns (uint256) {
        return a * b;
    }
}
```

## 调用方式

### 1. 直接调用（适用于所有函数）

```solidity
MathUtils.add(5, 10); // 返回 15
```

### 2. using for 附加到数据类型（仅限 internal 函数）

```solidity
using MathUtils for uint256; // 为 uint256 类型附加库函数

function demo() external pure returns (uint256) {
    uint256 a = 5;
    return a.add(10); // 等价于 MathUtils.add(a, 10)
}
```

## 操作调用合约的存储

库的 public/external 函数可通过 DELEGATECALL 修改调用合约的状态：

```solidity
library StorageLib {
    struct Data { uint256 value; }

    // 修改调用合约的存储（第一个参数必须是 storage 引用）
    function setValue(Data storage self, uint256 newValue) public {
        self.value = newValue;
    }
}

contract MainContract {
    StorageLib.Data public myData;

    function updateValue(uint256 _newValue) public {
        // 通过库函数修改 myData
        StorageLib.setValue(myData, _newValue);
    }
}
```

## 与普通合约的关键区别

特性 库（Library） 普通合约（Contract）
状态变量 ❌ 不能定义 storage ✅ 允许
继承 ❌ 不支持 ✅ 支持
接收以太币 ❌（除非实现 payable） ✅ 允许
函数内联 ✅ internal 函数内联 ❌ 无内联优化
Gas 成本 更低（复用代码） 更高（每次部署新实例）

## 知名库案例

### SafeMath（已弃用，Solidity ≥0.8 内置溢出检查）

过去用于安全的算术运算。

### Address

提供地址工具函数（如检查是否为合约）：

```solidity
using Address for address;
require(addr.isContract(), "Not a contract");
```

### Strings

处理字符串操作（如 toString()）。

## Gas 优化技巧

优先使用 internal 函数（内联调用无额外开销）。

复用已部署的库地址（避免重复部署）。

为复杂逻辑（如排序、加密）使用库，减少主合约大小。

## 注意事项

库的 selfdestruct 被禁用（永久不可变）。

避免在库中硬编码关键逻辑（防止库被恶意替换）。

明确函数类型：internal 用于计算，public 用于存储操作。

通过合理使用库，开发者能显著提升合约的安全性、可维护性和经济性。
