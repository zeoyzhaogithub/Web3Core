# 可支付(payable)

在 Solidity 中，可支付（Payable） 是一个关键概念，用于处理以太币（ETH）的收发。它主要应用于函数和地址，表示它们可以接收或发送以太币。以下是详细说明：

## 1. 可支付函数（Payable Functions）

当一个函数被标记为 payable 时：

- 可以接收 ETH：调用该函数时，可以附带发送以太币。
- 通过 msg.value 访问金额：函数内部可用 msg.value 获取发送的 ETH 数量（单位为 wei）。
- 非 Payable 函数拒绝 ETH：如果尝试向非 payable 函数发送 ETH，交易会失败。

### 示例

```solidity
function deposit() external payable {
    // 无需代码即可接收 ETH
    // msg.value 包含发送的 ETH 金额
}
```

## 2. 可支付地址（Payable Addresses）

普通地址类型（address）不能直接操作 ETH。必须转换为 address payable 类型：

- 支持 ETH 转账：
只有 address payable 类型可以调用 .transfer() 或 .send()。

- 转换方式：
address payable public owner = payable(0x...);

### 示例（向地址发送 ETH）

```solidity
function sendEther(address payable recipient) external payable {
    recipient.transfer(msg.value); // 发送 ETH
}
```

## 3. 关键操作

### 接收 ETH

通过 payable 函数或 receive() external payable 函数。

### 发送 ETH

使用 .transfer()（自动处理失败，推荐）：

```solidity
payable(address).transfer(amount);
```

或 .send()（需手动检查结果）：

```solidity
bool success = payable(address).send(amount);
require(success, "Transfer failed");
```

## 4. 特殊函数：receive 和 fallback

receive() external payable：
当调用附带 ETH 且无其他匹配函数时触发（如普通转账）。

fallback() external payable：
当调用无匹配函数且附带 ETH 时触发（需标记 payable）。

示例：

```solidity
receive() external payable {
    // 处理纯 ETH 转账
}

fallback() external payable {
    // 处理附带数据的 ETH 转账
}
```

## 5. 为什么需要 Payable？

安全性：明确区分哪些函数/地址能处理 ETH，防止意外转账。

Gas 优化：非 payable 函数跳过 ETH 检查，节省 Gas。

强制显式声明：开发者必须主动设计 ETH 处理逻辑。

## 实际应用场景

存款功能：用户向合约存入 ETH。

提款功能：合约向用户地址发送 ETH。

支付服务：用户调用服务时附带付款（如 NFT 购买）。

钱包合约：接收普通转账（触发 receive 函数）。

⚠️ 重要：处理 ETH 时需考虑重入攻击，使用 Checks-Effects-Interactions 模式或 OpenZeppelin 的 ReentrancyGuard。
