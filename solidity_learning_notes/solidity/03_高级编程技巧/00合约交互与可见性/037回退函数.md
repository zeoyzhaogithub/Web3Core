# 回退函数（fallback）

接发送eth
   Ether
    |
   is msg.data empty?
        /      \
       Yes      No
        /         \
receive() exists? fallback()
   /        \
   Yes       No
   |         |
receive() fallback()

部署成功，当前没有可调用的函数

![](./WeChatecd9a3b94bcd6675bdfa896807722db5.jpg)

输入value值，然后输入calldata中填入值，调用fallback
![](./WeChatf93c8adbf287875c8adfd8095aa1b6d4.jpg)

在日志里面就可以看到回退函数被调用
![](./WeChatcd744e852d236fba2d88d70dd0fb2832.jpg)

清空calldata，输入value值，点击transact按钮，receive被调用
![](./WeChatfad27017ab6cd0f580b65679ccae09cd.jpg)

在日志里面就可以看到回退函数被调用
![](./WeChat5ad3184e7d71ecd6bb4ca6ee3ff23d3b.jpg)

如果msg.data为空，则调用receive,否则调用fallback，如果receive函数不存在，则调用fallback。

---

在 Solidity 中，回退函数（Fallback Function） 是一种特殊函数，用于处理两种场景：

- 合约收到 普通以太币转账（无附加数据）

- 调用合约时 函数签名不匹配（调用了不存在的函数）

## 一、回退函数的类型（Solidity 0.6+）

自 Solidity 0.6 起，回退函数被拆分为两个独立函数：

|函数类型 |触发条件| 必须声明 |是否可处理 ETH|
|:---:|:---:|:---:|:---:|
|receive() |调用附带 ETH 但无调用数据| external |payable |✅ (自动接收)
|fallback() |调用函数不存在或有调用数据但无匹配函数| external [可选 payable] |需声明 payable

## 二、核心特性

### 可见性要求

必须声明为 external（不可用 public/internal）

receive() 必须标记 payable，否则无法接收 ETH

### Gas 限制

普通 ETH 转账（如 send()/transfer()）仅提供 2300 gas

复杂操作（如写存储、调用其他合约）将失败 ❌

需使用 call{value: x}("") 提供更多 gas

### 无函数名

是合约中唯一没有名称的函数

## 三、示例代码

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

contract PaymentHandler {
    event Received(address sender, uint amount);
    event FallbackCalled(bytes data);

    // 接收纯 ETH 转账（无数据）
    receive() external payable {
        emit Received(msg.sender, msg.value);
    }

    // 处理不存在的函数调用
    fallback() external payable {
        emit FallbackCalled(msg.data);
    }
}

```

## 四、典型应用场景

### 接收 ETH 转账

作为合约的“默认收款入口”（如多签钱包、捐赠合约）

### 代理合约（Proxy Patterns）

在可升级合约中，通过 fallback 将调用转发至逻辑合约：

```solidity
fallback() external payable {
    address impl = getImplementation();
    assembly {
        calldatacopy(0, 0, calldatasize())
        let result := delegatecall(gas(), impl, 0, calldatasize(), 0, 0)
        returndatacopy(0, 0, returndatasize())
        switch result
        case 0 { revert(0, returndatasize()) }
        default { return(0, returndatasize()) }
    }
}
```

### 简化交互

处理通用逻辑（如代币空投），无需预先定义具体函数

## 五、安全注意事项

### 重入攻击风险

在 fallback 中调用外部合约时，需防范重入攻击（使用 Checks-Effects-Interactions 模式）

### Gas 不足问题

避免在 receive() 中执行复杂逻辑（仅限 2300 gas）

### 明确拒绝 ETH

若不希望合约接收 ETH，可显式回退：

```solidity
receive() external payable {
    revert("ETH not accepted");
}
```

## 六、版本变化对比

Solidity 版本 回退函数方案
< 0.6.x 单函数 function() external payable
≥ 0.6.x 拆分为 receive() 和 fallback()

## 总结

回退函数是 Solidity 的安全网机制，合理使用可增强合约灵活性（如接收 ETH 或代理转发），但需严格注意 gas 限制和安全风险。在设计时，优先明确定义具体函数，仅在必要场景使用回退函数。
