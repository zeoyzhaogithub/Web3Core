# 合约事件

修改合约代码之后：

```bash
#1、部署 
npm run deploy:local

# 2、将新的合约地址添加到.env全局变量中

#3、重启
webpack yarn dev
```

```javascript
import { ethers } from "ethers";
import { abi } from "../artifacts/contracts/Counter.sol/Counter.json";
const ERROR = "未找到ethereum provider,请检查一下是否安装小狐狸钱包,或者还没有登陆钱包";

// 判断浏览器中是否有小狐狸这个插件
function getEth() {
    // @ts-ignore
    const eth = window.ethereum;
    if (!eth) {
        throw new Error(ERROR);
    }
    return eth;
}


// 判断账户是否可接入
// - 判断地址是否是非0，
// - 判断账户长度
async function requestAccess() {
    const eth = getEth();

    const result = await eth.request({
        method: "eth_requestAccounts"
    }) as string[];
    return result && result.length > 0;
}

// 是否有支持付费的账户
async function hasSigners() {
    const metamask = getEth();
    const signers = await metamask.request({ method: "eth_accounts" }) as string[];
    return signers.length > 0;
}

// 连接合约
async function getContract() {
    // 如果钱包没有接入，报错
    if (! await hasSigners() && !await requestAccess()) {
        throw new Error(ERROR);
    }
    const provider = new ethers.BrowserProvider(getEth());
    // 需要下面三个参数
    // 1、合约地址
    // 2、方法名称  abi,string
    // 3、provider
    // 4 signer 授权操作
    const address = process.env.CONTRACT_ADDRESS;

    // Contract不知道连接那个网络，但是全局的ethers知道，需要将两者联合起来，
    // 将启动后，控制台最后一行的To地址写到全局变量

    const contract = new ethers.Contract(
        address,
        abi,
        await provider.getSigner() // 可以获取钱包的私有信息
    );

    const counter = document.createElement("div");
    // 获取count的方法
    async function getCount() {
        counter.innerHTML = await contract.getCount();
    }
    getCount();
    // const contract = new ethers.Contract(
    //     address,
    //     ["function hello() public pure returns (string memory)"],
    //     provider
    // );
    // // 将数据展示到页面
    // document.body.innerHTML = await contract.hello();

    // 添加监听事件
    contract.on(contract.filters.CounterIncrement(), async function ({ args }) {
        console.log("setCount", args[0]);
        console.log("set----", args);
        counter.innerHTML = args[0].toString() || await contract.getCount();
    });
    // async function setCount() {
    //     await contract.count();
    //     // console.log("setCount", await counter.getCount());
    // }

    const button = document.createElement("button");
    button.innerHTML = "setCount";
    button.onclick = async function () {
        // const tx = await contract.count(); // transation 提交 不是等待transation完成
        // await tx.wait(); // 等待transation完成

        try {
            const tx = await contract.count();
            await tx.wait();
        } catch (error) {
            console.error("交易失败详情:", error.reason || error.message);

            // 获取更具体的错误数据
            if (error.info && error.info.error) {
                console.log("RPC错误详情:", error.info.error);
            }
        }
        getCount();
    }

    document.body.appendChild(counter);
    document.body.appendChild(button);

}

async function main() {
    await getContract();
}

main();
```
