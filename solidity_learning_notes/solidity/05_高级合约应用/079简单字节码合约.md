# 简单字节码合约

## 概念

字节码合约是直接以 EVM 字节码形式编写的智能合约，无需高级 Solidity 语法。这类合约通常用于：

- 极致优化 Gas 成本
- 极简功能实现（如固定返回值）
- 底层 EVM 机制研究

## 功能

以下实现一个最简单的字节码合约：

- 部署后：存储运行时字节码
- 调用时：始终返回固定值 0x42（32 字节格式）

## 实现步骤

编写运行时字节码：实现返回逻辑

编写初始化字节码：部署时返回运行时字节码

组合部署字节码：拼接初始化代码 + 运行时代码

部署到以太坊：发送交易执行部署

## 关键功能说明

### 1. 运行时字节码（5 字节）

```plaintext
6042     // PUSH1 0x42  (将值0x42压入栈)
6000     // PUSH1 0x00  (内存偏移量0)
52       // MSTORE      (存储到内存)
6020     // PUSH1 0x20  (返回长度32字节)
6000     // PUSH1 0x00  (内存起始位置)
F3       // RETURN      (返回数据)
```

作用：调用合约时返回 0x42 + 31 个零（32 字节）

### 2. 初始化字节码（12 字节）

```plaintext
6005     // PUSH1 0x05  (运行时代码长度)
600C     // PUSH1 0x0C  (代码中的偏移位置)
6000     // PUSH1 0x00  (内存目标位置)
39       // CODECOPY    (复制代码到内存)
6005     // PUSH1 0x05  (返回数据长度)
6000     // PUSH1 0x00  (内存起始位置)
F3       // RETURN      (返回运行时字节码)
```

作用：部署时返回运行时字节码

### 3. 完整部署字节码（17 字节）

```plaintext
0x6005600C60003960056000F3  // 初始化字节码 (12字节)

-

0x604260005260206000F3      // 运行时字节码 (5字节)
=

0x6005600c60003960056000f3604260005260206000f3
```

## 完整合约代码

### 1. 字节码形式（直接部署）

```solidity
部署字节码: 0x6005600c60003960056000f3604260005260206000f3
```

### 2. Solidity 工厂合约（推荐）

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

contract BytecodeContractDeployer {
    function deploy() public returns (address) {
        // 完整部署字节码
        bytes memory code = hex"6005600c60003960056000f3604260005260206000f3";
        address addr;

        // 使用汇编部署
        assembly {
            addr := create(0, add(code, 0x20), mload(code))
            if iszero(extcodesize(addr)) {
                revert(0, 0)
            }
        }
        return addr;
    }
    
    // 调用示例：返回 0x42
    function callContract(address _contract) public view returns (bytes memory) {
        (bool success, bytes memory data) = _contract.staticcall("");
        require(success, "Call failed");
        return data; // 返回 0x000...042 (32字节)
    }
}
```

## 具体流程

### 部署阶段

发送交易：将部署字节码作为 data 发送
EVM 执行初始化代码：

- CODECOPY 复制运行时字节码到内存
- RETURN 返回运行时字节码

链上存储：返回的代码存入合约地址

## 调用阶段

调用合约地址：无参数调用

EVM 执行运行时字节码：

- 将 0x42 存入内存
- 返回 32 字节数据 (0x42 + 31 个零)

输出结果：固定值 0x000...042

## 关键点解析

### Gas 成本

部署成本：~52,000 Gas

调用成本：~700 Gas（远低于常规合约）

### 内存布局

```plaintext
MSTORE(0x00, 0x42) → 内存变为：
[0x00]: 0x42... (后跟31字节0)
```

### 安全考虑

无状态变量 → 完全不可变

无外部调用 → 重入攻击免疫

此合约展示了 EVM 最底层的工作原理，适用于高级优化场景，但复杂业务推荐使用标准 Solidity 开发。
