# 事件

在 Solidity 中，事件（Events） 是智能合约与外部世界（如前端应用）通信的关键机制。它们允许合约在区块链上记录日志，这些日志可以被外部监听和查询，常用于通知用户界面更新、跟踪状态变化或审计合约操作。
事件在合约中被声明，然后在函数中被触发（emit）。事件的主要用途是记录日志，这些日志被存储在区块链的交易日志中，可以被外部应用程序访问。

## 事件的特点

1. **高效性**：事件比存储变量更节省Gas，因为日志数据存储在交易日志中，而不是合约的存储中。

2. **不可篡改**：一旦事件被触发并记录到区块链上，就无法被修改。

3. **可索引**：事件参数可以标记为`indexed`，这样允许外部应用程序通过索引参数来过滤事件。

4. **监听**：外部应用程序（如Web3.js或ethers.js）可以监听这些事件，并在事件发生时执行回调函数。

## 事件的核心作用

日志记录：将数据写入区块链的交易日志（不可篡改）

节省 Gas：比存储变量便宜约 8 倍（日志存储成本低）

链下监听：前端应用（Web3.js/ethers.js）可实时监听事件

索引过滤：支持通过 indexed 参数高效检索日志

## 事件的定义与触发

### 定义事件

事件使用`event`关键字进行声明，后面跟着事件名称和参数列表。参数中可以使用`indexed`关键字标记最多三个参数，以便于过滤。例如：

```solidity

// 示例：代币转账事件
event Transfer(
    address indexed from,    // 索引参数（可过滤）
    address indexed to,      // 索引参数
    uint256 value           // 非索引参数（存储在日志数据中）
);
```

### 触发事件

在函数中，使用`emit`关键字触发事件，并传入相应的参数。例如：

```solidity

function transfer(address _to, uint256 _value) public {

    // 转账逻辑...
    emit Transfer(msg.sender, _to, _value);
}

```

### 事件参数

- 非索引参数（默认）：这些参数被存储在日志的数据部分，不能被直接过滤，但可以被解析。

- 索引参数（使用`indexed`修饰）：这些参数被存储在日志的`topics`中，最多三个。索引参数允许外部应用程序通过指定条件（如特定的地址）来过滤事件。

## 前端监听事件（

### 使用ethers.js示例

```javascript

// 假设已经获取了合约实例 contract

// 监听所有 Transfer 事件
contract.on("Transfer", (from, to, value) => {
    console.log(`转账: ${from} -> ${to} ${value}代币`);
});

// 监听特定地址的转账（利用 indexed 过滤）
const filter = contract.filters.Transfer(null, "0x目标地址");
contract.on(filter, (from, to, value) => {
    console.log(`目标地址收到转账: ${value}代币`);
});

```

### 使用 Web3.js 查询历史事件

```javascript

// 过滤来自特定地址的Transfer事件
const events = await contract.getPastEvents("Transfer", {
    filter: { from: "0x特定地址" }, // 利用 indexed 过滤
    fromBlock: 0,
    toBlock: "latest"
});

```

## 关键设计建议

### 索引参数

对高频查询字段（如地址、ID）使用 indexed

```solidity
event OrderCreated(
    uint256 indexed orderId, // ID 可过滤
    address indexed buyer    // 买家地址可过滤
);
```

### 非索引参数

适合大文本或数组（如 string message），但检索效率较低

### Gas 优化

用事件替代存储变量记录历史数据（如用户操作日志）

### 安全注意

事件数据不可被合约读取，仅用于外部通知

## 事件在区块链中的存储

事件日志与交易相关联。当交易被挖出时，事件日志被存储在交易的收据（receipt）中。每个日志条目包含：

- 触发事件的合约地址

- 主题（topics）：第一个主题是事件签名的哈希值，后面跟着最多三个索引参数的主题。

- 数据（data）：非索引参数的ABI编码数据。

## 使用场景

代币交易：ERC-20 标准中的 Transfer 事件

NFT 转移：ERC-721 的 Transfer 事件

DAO 治理：投票结果通知

审计追踪：记录关键操作（如管理员变更）

前端更新：实时刷新用户余额/状态

## 完整示例合约

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

contract EventDemo {
    // 定义带索引的事件
    event UserRegistered(
        uint256 indexed userId,
        address indexed wallet,
        string username
    );

    uint256 public userCount;
    
    // 注册用户时触发事件
    function register(string memory _username) external {
        userCount++;
        emit UserRegistered(userCount, msg.sender, _username);
    }
}
```

## 注意事项

- 事件一旦被触发，就无法在链上被修改或删除。

- 事件日志只能由外部应用程序读取，合约内部无法读取。

- 虽然事件数据存储在区块链上，但并不是所有节点都会永久存储完整的日志历史（归档节点会存储）。

事件 vs. 状态变量
特性 事件（Events） 状态变量（Storage）
Gas 成本 低（约 2,000 Gas/日志） 高（约 20,000 Gas/变量）
数据访问 仅外部可读 合约内外均可访问
存储位置 交易日志 区块链存储
主要用途 通知、日志、审计 合约内部状态管理

总结：Solidity事件是合约与外部通信的桥梁，提供了高效、不可篡改的日志记录机制，并支持索引参数以实现事件过滤，是构建DApp不可或缺的部分。
