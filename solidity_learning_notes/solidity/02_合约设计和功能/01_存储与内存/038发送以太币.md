# 发送以太币

在 Solidity 中，发送以太币（Ether）主要有三种方式：`transfer`、`send` 和 `call`。随着 Solidity 版本的发展，推荐的方式也在变化。目前（Solidity 0.8.x 及以后版本），推荐使用 `call` 进行以太币的发送，因为 `transfer` 和 `send` 已被认为不够灵活，并且存在一些限制。

## 1. transfer最安全但限制最多）

`transfer` 如果发送失败（例如，接收方合约没有 payable 的回退函数，或者接收方合约在执行回退函数时耗尽了 gas），它会抛出一个异常（即 revert），并回滚整个交易。

语法：

```solidity

address payable receiver = payable(0xSomeAddress);

receiver.transfer(amount);

```

### 特点

- 发送固定数量的 wei。

- 如果失败，则整个交易回滚。

- 固定消耗 2300 gas（仅够触发日志/基础操作）

### 适用场景

简单转账给普通地址（EOA）或已知安全的合约

### 示例

```solidity
function sendViaTransfer(address payable _to) public payable {
    _to.transfer(msg.value); // 自动处理失败
}
```

## 2. send（不推荐使用）

`send` 如果发送失败，不会抛出异常，而是返回 `false`。因此，使用 `send` 时，必须检查返回值，否则可能导致资金丢失。

语法：

```solidity

address payable receiver = payable(0xSomeAddress);

bool success = receiver.send(amount);

if (!success) {

// 处理发送失败的情况，比如回滚等

}

```

### 特点

- 发送固定数量的 wei。

- 如果失败，返回 `false`（不会导致整个交易回滚，除非你手动 revert）。

- 传递的 gas 同样有限（2300 gas）。

### 缺点：需显式错误处理，易遗漏

### 现状：已逐步被淘汰

## 3. call()（最灵活但需谨慎）

目前，推荐使用 `call` 来发送以太币。`call` 是一个低级别的函数，可以自定义发送的 gas 和传递的数据。它返回一个布尔值表示调用是否成功，以及返回的数据（如果需要的话）。

### 发送以太币的语法

```solidity

address payable receiver = payable(0xSomeAddress);

(bool success, ) = receiver.call{value: amount, gas: gasAmount}("");

if (!success) {

// 处理失败

}

```

### 核心优势

可自定义 gas 上限（避免 gas 不足）

支持调用合约函数（如：call{value}(abi.encodeWithSignature("foo()"))）

### 重大风险

重入攻击漏洞（需配合防护机制）

安全实践：

```solidity

// 使用重入锁防护
bool private locked;
modifier noReentrant() {
    require(!locked, "No reentrancy");
    locked = true;
    _;
    locked = false;
}

function safeSend(address payable _to, uint amount) external noReentrant {
    (bool sent, ) = _to.call{value: amount}("");
    require(sent, "Failed");
}

```

### ⚠️ 关键安全建议

#### 重入攻击防护

优先使用 Checks-Effects-Interactions 模式

或使用 OpenZeppelin 的 ReentrancyGuard

#### gas 管理

给合约转账时预留足够 gas

普通转账建议至少 10,000 gas

#### 接收方验证

```solidity

require(receiver != address(0), "Invalid address"); 
require(address(this).balance >= amount, "Insufficient balance");

```

## 最佳实践总结

|  方法 |推荐度| 安全风险 |适用场景|
|  ---- | ---- | ---- | ---- |
call() |★★★★ |中| 需自定义 gas 的转账/调用函数
transfer| ★★★☆| 低| 简单转账给 EOA 地址
send()| ★| 高 |不推荐使用

## 📌 重要提示

在 Solidity 0.8.x 后官方推荐优先使用 call{value}()

向合约转账时，接收合约必须实现 receive() 或 fallback() 函数

始终假设接收方可能是恶意合约，做好重入防护
