# 常量

在Solidity中，常量（Constants）是一种特殊的变量，其值在编译时就已经确定，并且在合约的生命周期内不可改变。使用常量可以节省Gas费用，因为编译器会在编译时将常量替换为其实际值，从而避免了存储操作。

## 1. 常量（constant）

### 特点

- **不可变性**：一旦定义，值就不能再改变。

- **编译时确定**：常量的值必须在编译时就能确定，因此不能使用任何运行时才能确定的值（例如，区块时间戳、合约余额等）。必须用字面量或编译时可计算的表达式初始化（如 keccak256、type(...).max）

- **不占用存储空间**：值直接嵌入字节码，读取时无 SLOAD 操作（节省 Gas）。

- **命名规范**：通常使用全大写字母和下划线来命名常量（例如：`MAX_UINT256`）。

### 3. 常量可以使用的类型

常量可以用于值类型和字符串类型，也可以用于固定大小的数组（但需要注意，数组的每个元素都必须是编译时常量）。但是，不能用于动态数组、映射、结构体等复杂类型。

### 允许的初始化表达式

类型 合法示例 非法示例
数学运算 uint constant X = 10**18; X = block.timestamp
内置函数 bytes32 constant HASH = keccak256(...); HASH = sha256(...)
类型转换 address constant ADDR = address(1); -
类型属性 uint constant MAX = type(uint).max; -

### 示例

```solidity

// 值类型常量

uint256 constant public MAX_UINT256 = type(uint256).max;

address constant public MY_ADDRESS = 0x5B38Da6a701c568545dCfcB03FcB875f56beddC4;

bytes32 constant public MY_HASH = keccak256(abi.encodePacked("Hello World"));

string constant public GREETING = "Hello, World!";

// 固定大小数组常量

uint256[3] constant public ARRAY = [uint256(1), 2, 3];

```

注意：上面的`keccak256`和`abi.encodePacked`是在编译时可以计算的，因此可以作为常量初始化表达式。

## 二、不可变量（immutable）

特性（与 constant 对比）

特性 |constant| immutable
----- |:-------:|:---------:
赋值时机| 声明时| 构造函数中
值确定时机| 编译时| 部署时（运行时）
Gas 优化 |读取无成本| 读取成本极低（类似常量）
可用值 |仅编译时已知值| 运行时数据（如 msg.sender）

### 示例

```solidity
contract ImmutableExample {
    address public immutable deployer;
    uint256 public immutable creationTime;

    constructor() {
        deployer = msg.sender;           // 运行时赋值
        creationTime = block.timestamp;  // 运行时数据
    }
}
```

## 三、关键区别与使用场景

场景 |推荐使用 |原因
编译时已知的值（如配置）| constant |完全无 Gas 成本，值硬编码到字节码。
部署时确定的运行时数据| immutable |允许在构造函数赋值，节省存储 Gas（值直接嵌入调用数据，而非存储槽）。
需动态赋值的常量| ❌ 均不支持 |Solidity 无此功能，需用普通状态变量。

## 四、Gas 优化原理

- constant：值直接写入合约字节码，读取时通过 JUMP 指令获取，无存储访问。

- immutable：值在部署时写入合约的 code 段，读取时通过 EXTCODECOPY 加载，比 SLOAD 便宜 97%（约 100 Gas vs 2100 Gas）。

## 五、最佳实践与限制

### 仅支持值类型

常量/不可变量适用于：bool, uint, int, address, bytes32, string。
不支持：动态数组、结构体、映射。

### 访问权限

可标记为 public（自动生成 getter）或直接内部使用。

### 构造函数赋值限制

immutable 变量只能在构造函数中赋值一次，且不能再次修改。

### 接口与库中的常量

常量可定义在接口或库中，供多个合约复用：

```solidity
library Constants {
    uint256 public constant FEE_RATE = 100;
}
```

## 六、错误示例分析

```solidity
// 错误：block.timestamp 是运行时数据
uint constant TIME_NOW = block.timestamp;

// 错误：构造函数外赋值
address immutable owner;
function setOwner() public {
    owner = msg.sender; // 只能在构造函数赋值
}
```

## 总结

类型 赋值时机 值确定时机 适用场景
constant 声明时 编译时 数学常数、固定配置、哈希值
immutable 构造函数中 部署时 合约创建者、部署时间戳
合理使用常量/不可变量能大幅降低合约部署和调用的 Gas 成本，同时增强代码可读性和安全性。
